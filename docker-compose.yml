services:
  etcd-1:
    image: quay.io/coreos/etcd:v3.5.17
    container_name: pgha-etcd-1
    networks:
      - pgha-network
    volumes:
      - pgha_etcd1_data:/etcd-data
    command:
      - etcd
      - --name=etcd-1
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd-1:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd-1:2380
      - --initial-cluster=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      - --initial-cluster-token=etcd-cluster
      - --initial-cluster-state=new
      - --data-dir=/etcd-data
      - --enable-v2=true
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  etcd-2:
    image: quay.io/coreos/etcd:v3.5.17
    container_name: pgha-etcd-2
    networks:
      - pgha-network
    volumes:
      - pgha_etcd2_data:/etcd-data
    command:
      - etcd
      - --name=etcd-2
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd-2:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd-2:2380
      - --initial-cluster=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      - --initial-cluster-token=etcd-cluster
      - --initial-cluster-state=new
      - --data-dir=/etcd-data
      - --enable-v2=true
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  etcd-3:
    image: quay.io/coreos/etcd:v3.5.17
    container_name: pgha-etcd-3
    networks:
      - pgha-network
    volumes:
      - pgha_etcd3_data:/etcd-data
    command:
      - etcd
      - --name=etcd-3
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd-3:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd-3:2380
      - --initial-cluster=etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      - --initial-cluster-token=etcd-cluster
      - --initial-cluster-state=new
      - --data-dir=/etcd-data
      - --enable-v2=true
    healthcheck:
      test: ['CMD', 'etcdctl', 'endpoint', 'health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pg-1:
    build: ./docker/patroni
    container_name: pgha-pg-1
    networks:
      - pgha-network
    volumes:
      - pgha_pg1_data:/var/lib/postgresql/data
      - ./config/patroni:/etc/patroni
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REPLICATION_PASSWORD=${REPLICATION_PASSWORD}
      - PATRONI_SUPERUSER_PASSWORD=${PATRONI_SUPERUSER_PASSWORD}
      - PATRONI_REPLICATION_PASSWORD=${PATRONI_REPLICATION_PASSWORD}
      - PATRONI_NAME=pg-1
      - PATRONI_SCOPE=pgha-cluster
      - PATRONI_ETCD_HOSTS=etcd-1:2379,etcd-2:2379,etcd-3:2379
    depends_on:
      etcd-1: { condition: service_healthy, restart: true }
      etcd-2: { condition: service_healthy, restart: true }
      etcd-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://127.0.0.1:8008/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  pg-2:
    build: ./docker/patroni
    container_name: pgha-pg-2
    networks:
      - pgha-network
    volumes:
      - pgha_pg2_data:/var/lib/postgresql/data
      - ./config/patroni:/etc/patroni
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REPLICATION_PASSWORD=${REPLICATION_PASSWORD}
      - PATRONI_SUPERUSER_PASSWORD=${PATRONI_SUPERUSER_PASSWORD}
      - PATRONI_REPLICATION_PASSWORD=${PATRONI_REPLICATION_PASSWORD}
      - PATRONI_NAME=pg-2
      - PATRONI_SCOPE=pgha-cluster
      - PATRONI_ETCD_HOSTS=etcd-1:2379,etcd-2:2379,etcd-3:2379
    depends_on:
      etcd-1: { condition: service_healthy, restart: true }
      etcd-2: { condition: service_healthy, restart: true }
      etcd-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://127.0.0.1:8008/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  pg-3:
    build: ./docker/patroni
    container_name: pgha-pg-3
    networks:
      - pgha-network
    volumes:
      - pgha_pg3_data:/var/lib/postgresql/data
      - ./config/patroni:/etc/patroni
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REPLICATION_PASSWORD=${REPLICATION_PASSWORD}
      - PATRONI_SUPERUSER_PASSWORD=${PATRONI_SUPERUSER_PASSWORD}
      - PATRONI_REPLICATION_PASSWORD=${PATRONI_REPLICATION_PASSWORD}
      - PATRONI_NAME=pg-3
      - PATRONI_SCOPE=pgha-cluster
      - PATRONI_ETCD_HOSTS=etcd-1:2379,etcd-2:2379,etcd-3:2379
    depends_on:
      etcd-1: { condition: service_healthy, restart: true }
      etcd-2: { condition: service_healthy, restart: true }
      etcd-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://127.0.0.1:8008/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  pgbouncer-1:
    image: edoburu/pgbouncer:v1.23.1-p3
    container_name: pgha-pgbouncer-1
    networks:
      - pgha-network
    volumes:
      - ./config/pgbouncer:/etc/pgbouncer
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      pg-1: { condition: service_healthy, restart: true }
      pg-2: { condition: service_healthy, restart: true }
      pg-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'PGPASSWORD=changeme psql -h 127.0.0.1 -p 6432 -U postgres -d pgbouncer -c "SHOW DATABASES;"']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pgbouncer-2:
    image: edoburu/pgbouncer:v1.23.1-p3
    container_name: pgha-pgbouncer-2
    networks:
      - pgha-network
    volumes:
      - ./config/pgbouncer:/etc/pgbouncer
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      pg-1: { condition: service_healthy, restart: true }
      pg-2: { condition: service_healthy, restart: true }
      pg-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'PGPASSWORD=changeme psql -h 127.0.0.1 -p 6432 -U postgres -d pgbouncer -c "SHOW DATABASES;"']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pgbouncer-3:
    image: edoburu/pgbouncer:v1.23.1-p3
    container_name: pgha-pgbouncer-3
    networks:
      - pgha-network
    volumes:
      - ./config/pgbouncer:/etc/pgbouncer
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      pg-1: { condition: service_healthy, restart: true }
      pg-2: { condition: service_healthy, restart: true }
      pg-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'PGPASSWORD=changeme psql -h 127.0.0.1 -p 6432 -U postgres -d pgbouncer -c "SHOW DATABASES;"']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  haproxy:
    image: haproxy:lts-alpine
    container_name: pgha-haproxy
    networks:
      - pgha-network
    ports:
      - "5000:5000"
      - "5001:5001"
      - "7000:7000"
    volumes:
      - ./config/haproxy:/usr/local/etc/haproxy
    depends_on:
      pgbouncer-1: { condition: service_healthy, restart: true }
      pgbouncer-2: { condition: service_healthy, restart: true }
      pgbouncer-3: { condition: service_healthy, restart: true }
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://127.0.0.1:7000/stats || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  pgha-network:
    driver: bridge

volumes:
  pgha_pg1_data:
  pgha_pg2_data:
  pgha_pg3_data:
  pgha_etcd1_data:
  pgha_etcd2_data:
  pgha_etcd3_data:
